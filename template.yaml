AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Botman AI – Etap 1 (prod-ready)

Parameters:
  PhoneHashPepperParam:
    Type: String
    Default: /botman/prod/phone_hash_pepper
  UserHashPepperParam:
    Type: String
    Default: /botman/prod/user_hash_pepper
  OtpHashPepperParam:
    Type: String
    Default: /botman/prod/otp_hash_pepper

  SesFromEmail:
    Type: String

  DevMode:
    Type: String
  LangDefault:
    Type: String

  TwilioAccountSid:
    Type: String
  TwilioAuthToken:
    Type: String
  TwilioMessagingSid:
    Type: String
    Default: ""      
  TwilioWhatsappNumber:
    Type: String

  OpenAiApiKey:
    Type: String
  LlmModel:
    Type: String

  PgBaseUrl:
    Type: String
  PgClientId:
    Type: String
  PgClientSecret:
    Type: String

  JiraUrl:
    Type: String
  JiraToken:
    Type: String
  JiraProjectKey:
    Type: String
    
Globals:
  Function:
    Runtime: python3.11
    Timeout: 25
    MemorySize: 512
    Tracing: Active
    Environment:
      Variables:
       # !!! UWAGA !!!
        # Sekcja ENV z nazwami DDB/SQS/S3 jest traktowana jako "infra".
        # Przy zmianach samego kodu NIE ruszamy:
        #   - nazewnictwa kolejek
        #   - TableName w DDB
        #   - nazwy bucketów
        # Zmieniać można:
        #   - kod (src/*)
        #   - handler/timeout/memory Lambd
        #   - zwykłe zmienne ENV nietrzymające nazw zasobów (np. LANG_DEFAULT).
        PYTHONPATH: /var/task/src
        DEV_MODE:           !Ref DevMode
        LANG_DEFAULT:       !Ref LangDefault

        TWILIO_ACCOUNT_SID:     !Ref TwilioAccountSid 
        TWILIO_AUTH_TOKEN:      !Ref TwilioAuthToken
        TWILIO_MESSAGING_SID:   !Ref TwilioMessagingSid
        TWILIO_WHATSAPP_NUMBER: !Ref TwilioWhatsappNumber

        OPENAI_API_KEY:  !Ref OpenAiApiKey
        LLM_MODEL:       !Ref LlmModel
        PHONE_HASH_PEPPER: !Ref PhoneHashPepperParam
        USER_HASH_PEPPER: !Ref UserHashPepperParam
        OTP_HASH_PEPPER: !Ref OtpHashPepperParam

        PG_BASE_URL:      !Ref PgBaseUrl
        PG_CLIENT_ID:     !Ref PgClientId
        SES_FROM_EMAIL: !Ref SesFromEmail
        PG_CLIENT_SECRET: !Ref PgClientSecret

        JIRA_URL:         !Ref JiraUrl
        JIRA_TOKEN:       !Ref JiraToken
        JIRA_PROJECT_KEY: !Ref JiraProjectKey
        
        DDB_TABLE_TENANTS: !Sub 'Tenants-${AWS::StackName}'
        DDB_TABLE_CONVERSATIONS: !Sub 'Conversations-${AWS::StackName}'
        DDB_TABLE_MESSAGES:      !Sub 'Messages-${AWS::StackName}'
        DDB_TABLE_TEMPLATES:     !Sub 'Templates-${AWS::StackName}'
        DDB_TABLE_CAMPAIGNS:     !Sub 'Campaigns-${AWS::StackName}'
        DDB_TABLE_CONSENTS:      !Sub 'Consents-${AWS::StackName}'
        DDB_TABLE_INTENTS_STATS: !Sub 'IntentsStats-${AWS::StackName}'
        DDB_TABLE_MEMBERS_INDEX: !Sub 'MembersIndex-${AWS::StackName}'
        DDB_TABLE_LEADS:         !Sub 'Leads-${AWS::StackName}'
        DDB_TABLE_IDEMPOTENCY:   !Sub 'Idempotency-${AWS::StackName}'
        
        KB_BUCKET: !Ref KnowledgeBaseBucket
        
        CAMPAIGN_SEND_FROM: "09:00"
        CAMPAIGN_SEND_TO: "20:00"

        # Retencja danych (housekeeping)
        #MESSAGES_RETENTION_DAYS: "365"
        #CONVERSATIONS_RETENTION_DAYS: "365"
        MESSAGES_RETENTION_DAYS: "5"
        CONVERSATIONS_RETENTION_DAYS: "5"
        SPAM_STATS_MAX_AGE_SECONDS: "86400"
           

Resources:
  # --- API ---
  MyApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      EndpointConfiguration: REGIONAL
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          ThrottlingRateLimit: 50
          ThrottlingBurstLimit: 100

  # --- WAF ---
  ApiWebAcl:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: !Sub 'botman-api-waf-${AWS::StackName}'
      Scope: REGIONAL
      DefaultAction:
        Allow: {}
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: !Sub 'botman-api-waf-${AWS::StackName}'
      Rules:
        - Name: RateLimitPerIP
          Priority: 0
          Action:
            Block: {}
          Statement:
            RateBasedStatement:
              Limit: 2000
              AggregateKeyType: IP
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: RateLimitPerIP

  ApiWebAclAssociation:
    Type: AWS::WAFv2::WebACLAssociation
    DependsOn:
      - ApiWebAcl
      - MyApiProdStage
    Properties:
      WebACLArn: !GetAtt ApiWebAcl.Arn
      ResourceArn: !Sub 'arn:aws:apigateway:${AWS::Region}::/restapis/${MyApi}/stages/Prod'

  # --- SQS ---

  InboundEventsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'inbound-events-${AWS::StackName}.fifo'
      FifoQueue: true
      ContentBasedDeduplication: false
      VisibilityTimeout: 60
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt InboundDLQ.Arn
        maxReceiveCount: 5
        
  InboundDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'inbound-events-${AWS::StackName}-dlq.fifo'
      FifoQueue: true
      ContentBasedDeduplication: false

  OutboundQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'outbound-messages-${AWS::StackName}'
      VisibilityTimeout: 60
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt OutboundDLQ.Arn
        maxReceiveCount: 5
  OutboundDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'outbound-messages-${AWS::StackName}-dlq'

  # --- DynamoDB ---
  Tenants:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub 'Tenants-${AWS::StackName}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: tenant_id
          AttributeType: S
        - AttributeName: twilio_to
          AttributeType: S         
      KeySchema:
        - AttributeName: tenant_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: TwilioToIndex
          KeySchema:
            - AttributeName: twilio_to
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  Conversations:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub 'Conversations-${AWS::StackName}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      TimeToLiveSpecification:
          AttributeName: ttl_ts
          Enabled: true

  Messages:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub 'Messages-${AWS::StackName}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      TimeToLiveSpecification:
          AttributeName: ttl_ts
          Enabled: true


  Idempotency:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      UpdateReplacePolicy: Retain
      Properties:
        TableName: !Sub 'Idempotency-${AWS::StackName}'
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: pk
            AttributeType: S
        KeySchema:
          - AttributeName: pk
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
          
  Templates:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub 'Templates-${AWS::StackName}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH

  Campaigns:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub 'Campaigns-${AWS::StackName}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH

  Consents:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub 'Consents-${AWS::StackName}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH

  IntentsStats:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub 'IntentsStats-${AWS::StackName}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      TimeToLiveSpecification:
          AttributeName: ttl_ts
          Enabled: true
  
  Leads:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub 'Leads-${AWS::StackName}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
          
  MembersIndex:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub 'MembersIndex-${AWS::StackName}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: tenant_id
          AttributeType: S
        - AttributeName: phone_hmac
          AttributeType: S
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: tenant_phone_hmac_idx
          KeySchema:
            - AttributeName: tenant_id
              KeyType: HASH
            - AttributeName: phone_hmac
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          
  # --- S3 ---
  KnowledgeBaseBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !Sub '${AWS::StackName}-kb-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled

  # --- IAM snippets (inline via Policies) ---
  # Shared SSM+KMS access policy (copy/paste into each function Policies)
  # NOTE: using kms:Decrypt with ViaService constraint (works with default SSM key + most setups)
  #
  # If you use a custom CMK for SecureString params, replace Resource: "*" with that key ARN.

  InboundWebhookFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'inbound-webhook-${AWS::StackName}'
      CodeUri: .
      Handler: src/lambdas/inbound_webhook/handler.lambda_handler
      Policies:
        - SQSSendMessagePolicy:
            QueueName: !GetAtt InboundEventsQueue.QueueName
        - DynamoDBCrudPolicy:             
            TableName: !Ref IntentsStats
        - Statement:
            - Effect: Allow
              Action: ssm:GetParameter
              Resource:
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${PhoneHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${UserHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${OtpHashPepperParam}'
            - Effect: Allow
              Action: kms:Decrypt
              Resource: "*"
              Condition:
                StringEquals:
                  kms:ViaService: !Sub 'ssm.${AWS::Region}.amazonaws.com'
            - Effect: Allow
              Action:
                 - dynamodb:Query
              Resource:
                 - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/Tenants-${AWS::StackName}/index/TwilioToIndex'
      Environment:
        Variables:
          InboundEventsQueueUrl: !Ref InboundEventsQueue
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /webhooks/twilio
            Method: post

  MessageRouterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'message-router-${AWS::StackName}'
      CodeUri: .
      Handler: src/lambdas/message_router/handler.lambda_handler
      Policies:
        - SQSPollerPolicy:
            QueueName: !GetAtt InboundEventsQueue.QueueName
        - SQSSendMessagePolicy:
            QueueName: !GetAtt OutboundQueue.QueueName

        - DynamoDBCrudPolicy:
            TableName: !Ref Messages
        - DynamoDBCrudPolicy:
            TableName: !Ref Conversations
        - DynamoDBCrudPolicy:
            TableName: !Ref Idempotency
        - DynamoDBCrudPolicy:
            TableName: !Ref Leads 
        - DynamoDBReadPolicy:
            TableName: !Ref Templates
        - DynamoDBReadPolicy:
            TableName: !Ref Tenants
        - DynamoDBReadPolicy:
            TableName: !Ref MembersIndex

        - S3ReadPolicy:
            BucketName: !Ref KnowledgeBaseBucket

        - Statement:
            - Effect: Allow
              Action:
               - comprehend:DetectDominantLanguage
              Resource: "*"

            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${PhoneHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${UserHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${OtpHashPepperParam}'

            - Effect: Allow
              Action:
                - kms:Decrypt
              Resource: "*"
              Condition:
                StringEquals:
                  kms:ViaService: !Sub 'ssm.${AWS::Region}.amazonaws.com'

            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
              Resource: "*"
      Environment:
        Variables:
          OutboundQueueUrl: !Ref OutboundQueue      
          COMPREHEND_REGION: !Ref AWS::Region
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt InboundEventsQueue.Arn
            BatchSize: 10
            FunctionResponseTypes:
              - ReportBatchItemFailures

  OutboundSenderFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'outbound-sender-${AWS::StackName}'
      CodeUri: .
      Handler: src/lambdas/outbound_sender/handler.lambda_handler
      Policies:
        - SQSPollerPolicy:
            QueueName: !GetAtt OutboundQueue.QueueName      
        - DynamoDBCrudPolicy:
            TableName: !Ref Idempotency
        - Statement:
            - Effect: Allow
              Action: ssm:GetParameter
              Resource:
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${PhoneHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${UserHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${OtpHashPepperParam}'
            - Effect: Allow
              Action: kms:Decrypt
              Resource: "*"
              Condition:
                StringEquals:
                  kms:ViaService: !Sub 'ssm.${AWS::Region}.amazonaws.com'
      Environment:
        Variables:    
          WebOutboundEventsQueueUrl: !Ref OutboundQueue
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt OutboundQueue.Arn
            BatchSize: 20
            MaximumBatchingWindowInSeconds: 2
            FunctionResponseTypes:
              - ReportBatchItemFailures

  CampaignRunnerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'campaign-runner-${AWS::StackName}'
      CodeUri: .
      Handler: src/lambdas/campaign_runner/handler.lambda_handler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref Campaigns
        - SQSSendMessagePolicy:
            QueueName: !GetAtt OutboundQueue.QueueName 
        - DynamoDBReadPolicy:
            TableName: !Ref Consents
        - Statement:
            - Effect: Allow
              Action: ssm:GetParameter
              Resource:
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${PhoneHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${UserHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${OtpHashPepperParam}'
            - Effect: Allow
              Action: kms:Decrypt
              Resource: "*"
              Condition:
                StringEquals:
                  kms:ViaService: !Sub 'ssm.${AWS::Region}.amazonaws.com'
      Environment:
        Variables:
          OutboundQueueUrl: !Ref OutboundQueue
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: rate(1 day)

  HousekeepingFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'housekeeping-${AWS::StackName}'
      CodeUri: .
      Handler: src/lambdas/housekeeping/handler.lambda_handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref Messages
        - DynamoDBCrudPolicy:
            TableName: !Ref Conversations
        - DynamoDBCrudPolicy:  
            TableName: !Ref IntentsStats
        - Statement:
            - Effect: Allow
              Action: ssm:GetParameter
              Resource:
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${PhoneHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${UserHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${OtpHashPepperParam}'
            - Effect: Allow
              Action: kms:Decrypt
              Resource: "*"
              Condition:
                StringEquals:
                  kms:ViaService: !Sub 'ssm.${AWS::Region}.amazonaws.com'

      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: rate(1 day)

  PgReservationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'pg-reservations-${AWS::StackName}'
      CodeUri: .
      Handler: src/lambdas/pg_reservations/handler.lambda_handler
      Policies:
        - Statement:
            - Effect: Allow
              Action: ssm:GetParameter
              Resource:
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${PhoneHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${UserHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${OtpHashPepperParam}'
            - Effect: Allow
              Action: kms:Decrypt
              Resource: "*"
              Condition:
                StringEquals:
                  kms:ViaService: !Sub 'ssm.${AWS::Region}.amazonaws.com'
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /api/pg/test
            Method: post
            
  WebWidgetFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'web-widget-${AWS::StackName}'
      CodeUri: .
      Handler: src/lambdas/web_widget/handler.lambda_handler
      Policies:
        - SQSSendMessagePolicy:
            QueueName: !GetAtt InboundEventsQueue.QueueName
        - Statement:
            - Effect: Allow
              Action: ssm:GetParameter
              Resource:
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${PhoneHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${UserHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${OtpHashPepperParam}'
            - Effect: Allow
              Action: kms:Decrypt
              Resource: "*"
              Condition:
                StringEquals:
                  kms:ViaService: !Sub 'ssm.${AWS::Region}.amazonaws.com'
      Environment:
        Variables:
          InboundEventsQueueUrl: !Ref InboundEventsQueue
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /web/widget
            Method: post

  HealthFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'health-${AWS::StackName}'
      CodeUri: src
      Handler: src/lambdas/health/handler.lambda_handler
      Policies:
        - Statement:
            - Effect: Allow
              Action: ssm:GetParameter
              Resource:
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${PhoneHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${UserHashPepperParam}'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${OtpHashPepperParam}'
            - Effect: Allow
              Action: kms:Decrypt
              Resource: "*"
              Condition:
                StringEquals:
                  kms:ViaService: !Sub 'ssm.${AWS::Region}.amazonaws.com'
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /health
            Method: get

Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL
    Value: !Sub 'https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/webhooks/twilio'
  PgTestUrl:
    Description: API Gateway endpoint URL for PerfectGym manual test
    Value: !Sub 'https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/api/pg/test'
